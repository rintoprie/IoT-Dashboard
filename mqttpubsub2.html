<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MQTT Publish & Subscribe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .logbox { height: 200px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-3">MQTT Publish & Subscribe Client</h2>

    <!-- Connect Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Broker URL</label>
            <input id="broker" class="form-control" value="ws://test.mosquitto.org:8081" />
          </div>
          <div class="col-md-5">
            <label class="form-label">Client ID</label>
            <input id="clientId" class="form-control" value="webclient_" />
          </div>
          <div class="col-md-3 d-flex align-items-end gap-2">
            <button id="connectBtn" class="btn btn-primary flex-shrink-0">Connect</button>
            <span id="status" class="fw-semibold text-danger">Offline</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Publish Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Publish</h5>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Topic</label>
            <input id="topic" class="form-control" value="test/topic" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Payload</label>
            <input id="payload" class="form-control" value="Hello MQTT!" />
          </div>
          <div class="col-md-3">
            <label class="form-label">QoS</label>
            <select id="qos" class="form-select">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end gap-2">
            <button id="publishBtn" class="btn btn-success" disabled>Publish</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscribe Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Subscribe</h5>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="subTopic" class="form-label">Subscribe Topic</label>
            <input id="subTopic" type="text" class="form-control" placeholder="test/topic" value="test/topic" />
          </div>
          <div class="col-md-5">
            <label for="subQos" class="form-label">QoS</label>
            <select id="subQos" class="form-select">
              <option value="0" selected>0 - At most once</option>
              <option value="1">1 - At least once</option>
              <option value="2">2 - Exactly once</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end gap-2">
            <button id="subscribeBtn" class="btn btn-outline-primary mb-2" disabled>Subscribe</button>
            <button id="unsubscribeBtn" class="btn btn-outline-secondary mb-2" disabled>Unsubscribe</button>
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Inbox (incoming messages)</label>
          <div id="inbox" class="bg-light text-success rounded p-2 mono overflow-auto logbox"></div>
        </div>
      </div>
    </div>

    <!-- Log Card -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Log</h5>
        <div id="log" class="bg-light text-success rounded p-2 mono overflow-auto logbox"></div>
      </div>
    </div>
  </div>

  <script>
    const brokerEl = document.getElementById('broker');
    const clientIdEl = document.getElementById('clientId');
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    // Publish elements
    const topicEl = document.getElementById('topic');
    const payloadEl = document.getElementById('payload');
    const qosEl = document.getElementById('qos');
    const publishBtn = document.getElementById('publishBtn');

    // Subscribe elements
    const subTopicEl = document.getElementById('subTopic');
    const subQosEl = document.getElementById('subQos');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const unsubscribeBtn = document.getElementById('unsubscribeBtn');
    const inboxEl = document.getElementById('inbox');
    const ACTIVE_SUBS = new Map();

    let client = null;

    function log(msg){
      const div = document.createElement('div');
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text, cls){
      statusEl.textContent = text;
      statusEl.classList.toggle('text-success', cls==='ok');
      statusEl.classList.toggle('text-danger', cls==='offline');
    }

    function setSubButtonsEnabled(on){
      subscribeBtn.disabled = !on;
      unsubscribeBtn.disabled = !on;
    }

    connectBtn.addEventListener('click', () => {
      if(client && client.connected){
        client.end();
        setStatus('Offline','offline');
        connectBtn.textContent = 'Connect';
        publishBtn.disabled = true;
        setSubButtonsEnabled(false);
        log('Disconnected');
        return;
      }

      const broker = brokerEl.value;
      const clientId = clientIdEl.value + Math.random().toString(16).substr(2,8);

      client = mqtt.connect(broker, { clientId });

      client.on('connect', () => {
        setStatus('Connected','ok');
        connectBtn.textContent = 'Disconnect';
        publishBtn.disabled = false;
        setSubButtonsEnabled(true);
        log('Connected as ' + clientId);

        ACTIVE_SUBS.forEach((qos, topic) => {
          client.subscribe(topic, { qos }, (err) => {
            if(err){ log('Re-subscribe error: ' + err); }
          });
        });
      });

      client.on('close', () => {
        setStatus('Offline','offline');
        connectBtn.textContent = 'Connect';
        publishBtn.disabled = true;
        setSubButtonsEnabled(false);
        log('Connection closed');
      });

      client.on('message', (topic, message, packet) => {
        let payload = message ? message.toString() : '';
        try { payload = JSON.stringify(JSON.parse(payload)); } catch {}
        pushInbox(topic, payload, packet && packet.qos);
      });

      client.on('error', err => log('Error: '+err));
    });

    publishBtn.addEventListener('click', () => {
      if(!client || !client.connected){ alert('Not connected'); return; }
      const topic = topicEl.value;
      const payload = payloadEl.value;
      const qos = Number(qosEl.value);
      client.publish(topic, payload, { qos }, (err) => {
        if(err){ log('Publish error: '+err); return; }
        log(`Published '${payload}' to ${topic} (QoS ${qos})`);
      });
    });

    function pushInbox(topic, payload, qos){
      const t = new Date().toLocaleString();
      const line = `[${t}] ${topic} (QoS ${qos}): ${payload}`;
      const div = document.createElement('div');
      div.textContent = line;
      inboxEl.appendChild(div);
      const MAX = 200;
      while(inboxEl.childElementCount > MAX){ inboxEl.removeChild(inboxEl.firstChild); }
      inboxEl.scrollTop = inboxEl.scrollHeight;
    }

    function subscribeNow(){
      if(!client || !client.connected){ alert('Not connected'); return; }
      const topic = subTopicEl.value.trim();
      const qos = Number(subQosEl.value || 0);
      if(!topic){ alert('Enter a subscribe topic'); return; }
      client.subscribe(topic, { qos }, (err, granted) => {
        if(err){ log('Subscribe error: ' + err); return; }
        ACTIVE_SUBS.set(topic, qos);
        const g = granted && granted[0] ? ` (granted QoS ${granted[0].qos})` : '';
        log(`Subscribed to ${topic}${g}`);
      });
    }

    function unsubscribeNow(){
      if(!client || !client.connected){ alert('Not connected'); return; }
      const topic = subTopicEl.value.trim();
      if(!topic){ alert('Enter a topic to unsubscribe'); return; }
      client.unsubscribe(topic, (err) => {
        if(err){ log('Unsubscribe error: ' + err); return; }
        ACTIVE_SUBS.delete(topic);
        log(`Unsubscribed from ${topic}`);
      });
    }

    subscribeBtn.addEventListener('click', subscribeNow);
    unsubscribeBtn.addEventListener('click', unsubscribeNow);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
